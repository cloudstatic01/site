---
title: Data Analysis Report
subtitle: Prepared by Hayk Manasyan
date: 2020-08-01
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
library(plotly)
knitr::opts_chunk$set(echo = FALSE)
```

### Project Goal

The goal of this project is to evaluate the trends in new and used car sales to understand the influence of world events on the number of units sold and the total dollar amount.

I hypothesize that there will be a decrease in the number of units sold and the total value during the years of 2008-2009 due to the financial crisis as well as a decline in sales in the spring of 2020 due to the COVID-19 pandemic.

### Data Summary

Since the year of 2002, Maryland car sales have been recorded in terms of units and dollar values for both the new and used categories. The values are recorded on a monthly basis. I want to model the sales by unit and dollar amount for both the new and used categories to see how they are affected over time by world events, as well as to see the differences in the sale of new cars versus used cars per month.

Data were downloaded from https://opendata.maryland.gov/resource/un65-7ipd.json on  `r format(Sys.time(), '%d %B, %Y')`. 

```{r getting_data}
#getting the data
fname = "car_sales.rds"
if (!file.exists(fname)) {
res = httr::GET("https://opendata.maryland.gov/resource/un65-7ipd.json")
df = jsonlite::fromJSON(httr::content(res, as = "text"), flatten = TRUE)
df = df %>%
  rename_all(tolower)
df = as_tibble(df)
write_rds(df, fname)
} else {
  df = read_rds(fname)
}
```

```{r dataprep}
#getting the data ready to plot

df = df %>%
  mutate(month = factor(
    month,
    levels = c("JAN", "FEB", "MAR", "APR",
               "MAY", "JUN", "JUL", "AUG", "SEP",
               "OCT", "NOV", "DEC")),
    month = as.numeric(month),
    new = parse_number(new),
    used = parse_number(used),
    total_sales_new = parse_number(total_sales_new),
    total_sales_used = parse_number(total_sales_used))
```

### Statistical Approach and Analysis

#### 1. Pre-processing

I used the data for the total units sold and the dollar amounts for both the new and used categories. I created a data frame which will update from the website. Character objects were converted to numeric and months of each year  - to categories for plotting. 


#### 2. Approach

Monthly units sold and total value amounts were plotted using line plots generated by the ggplot package. Each year was shown as a separate trend-line with 2008, 2009 and 2020 highlighted to depict the hypothesized changes. To quantify the changes, I calculated percent change between consecutive months. To reveal the change due to COVID-19, the first six months of the years 2018-2020, month to month percent change for units sold and total value are presented. In the table below, positive numbers indicate growth, while negative numbers indicate loss compared to the previous month of the year. January is left as NA to not compare with December of the previous year.


### Results

#### 1. Overall Trends

Figures 1 and 2 show the total number of units sold for new and used vehicles. As hypothesized, we observed a sharp decline in units sold for both new and used between the months of March and April in 2020 due to the beginning of shutdowns due to COVID-19.There is a especially large decline in used car sales in this time period, compared to new car sales. This decline is reversed by a comparable increase from May to June 2020. 

  All other years appear to have consistent trend lines. However, the number of units begin to decline at the end of 2008 with the lowest numbers of new cars sold for almost all of 2009 mirroring the fiscal crisis at the time. The gap between 2008 and 2009 is not as pronounced for the sale of used cars. However, the numbers are still among the lowest. 

```{r}
df <- df %>%
  mutate(mysize = 0.5)
df = df %>%
  mutate(mysize = ifelse(year %in% c(2008, 2009, 2020), 0.75, mysize))

# create one plot
g = df %>%
  ggplot(
    aes(x = month, colour = factor(year),
        alpha = I(mysize),
        size = mysize
    )
  ) +
  scale_size(range = c(0.5, 1.5), guide="none") +
  scale_x_continuous(breaks=1:12) +
  scale_y_continuous(labels = scales::comma)
```

```{r new}
gnew = g +
  geom_line(aes(y = new)) +
  labs(title = "Fig. 1: Total New Units Sold Per Month" ,
       y= "Total Units",
       x="Month", colour="Year")
gnew
```
```{r used}
gused = g +
  geom_line(aes(y = used)) +
  labs(title = "Fig. 2: Total Used Units Sold Per Month" ,
       y= "Total Units" , x="Month", colour="Year")
gused
```


Figures 3 and 4 show the total dollar amount of sales for new and used vehicles. There is a similar sharp decline in sales for both new and used between the months of March and April in 2020. All other years appear to have consistent trend lines. However, the numbers for the years 2008 and 2009 appear to be the smallest, but they still follow the consistent pattern.

```{r newsale}
gsale = g + labs(y= "Total Dollar Amount" , x="Month", colour="Year")
gnewsale = gsale +
  geom_line(aes(y = total_sales_new)) +
  labs(title = "Fig. 3: Total New Car Sales ($) Per Month")
gnewsale
```

```{r usedsale}
gsale = g + labs(y= "Total Dollar Amount" , x="Month", colour="Year")
gusedsale = gsale +
  geom_line(aes(y = total_sales_used)) +
  labs(title = "Fig. 4: Total New Car Sales ($) Per Month")
gusedsale
```


#### 2. Percent Changes

The calculated percent change for the first six months was compared from 2018 to 2020 and is presented in the table below.

There is a consistent decline in February, with a rebound in March for all years. Changes in the month of April are near negligible, except for 2020, when new car sales saw about 40% decline while used car sales saw about 50% decline compared to March. The month of May shows a small increase in sales, and the increase/decrease in June is negligible except for 2020. The month of June sees a near 60% increase in new cars sales, and about 70% increase in used car sales.

```{r}
#This section calculates the percent change from
# month to month except for January of each year

long = df %>%
  select( -one_of("mysize")) %>%
  gather(metric, value, -year, -month) %>%
  group_by(year, metric) %>%
  arrange(year, metric, month) %>%
  mutate(lag_value = lag(value),
         month1_value = value[month == 1])
long = long %>%
  ungroup() %>%
  # here is our percentage!
  mutate(
    value_m1 = round((value / month1_value - 1) * 100),
    value = round((value / lag_value - 1) * 100, 1),
  )

wide = long  %>%
  select(-one_of(c("month1_value", "lag_value", "value_m1"))) %>%
  spread(metric, value)

recent_years = wide %>%
  filter(year %in% c(2018, 2019, 2020), month %in% 1:6)

knitr::kable(recent_years)
```

Figures 5 and 6 are showing percent change for the years 2002-2020 from previous months and January of the current year, respectively. Similar to the table above, positive values indicate an increase and negative values - a loss.


```{r}
g = long %>%
  ggplot(
    aes(x = month, 
        colour = factor(year),
    )
  ) +
  scale_size(range = c(0.5, 1.5), guide="none") +
  scale_x_continuous(breaks=1:12) +
  facet_wrap(~ metric, scales = "free_x")

g + geom_line(aes(y = value)) +
  labs(title = "Fig. 5: Percent Change From Month to Month" ,
       y= "Percent Change",
       x="Month", colour="Year")

g + geom_line(aes(y = value_m1)) +
  labs(title = "Fig. 6: Percent Change From January of the Current Year" ,
       y= "Percent Change",
       x="Month", colour="Year")

```

#### Acknowledgements

My special thanks to Dr.John Muschelli for his invaluable help with this report.
